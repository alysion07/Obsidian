# VSMR 시뮬레이터 웹 에디터 프로젝트 소개

> 원자로 열수력 해석 코드 MARS의 입력 파일을 시각적으로 생성하고, 시뮬레이션을 실행/모니터링하는 웹 기반 도구

---

## 1. 배경: MARS 시뮬레이터란?

**MARS (Multi-dimensional Analysis of Reactor Safety)**는 원자력 발전소의 **열수력 현상**을 해석하는 시뮬레이션 코드입니다.

간단히 말해, 원자로 냉각계통 내 유체(물/증기)의 흐름을 예측하는 도구입니다:

- **압력**, **온도**, **유량** 변화 계산
- 배관 내 **상변화** (물 ↔ 증기) 추적
- 사고 시나리오 분석 (냉각수 상실 등)

### 열수력 모델링 방식

MARS는 복잡한 배관 시스템을 **노드-링크 네트워크**로 단순화합니다:

```
┌─────────┐      Junction      ┌─────────┐
│ Volume  │ ◄───────────────► │ Volume  │
│ (탱크)  │   (유체 연결점)    │ (배관)  │
└─────────┘                    └─────────┘
```

| 개념 | 설명 | 예시 |
|------|------|------|
| **Volume** | 유체가 존재하는 공간 | 탱크, 배관, 헤더 |
| **Junction** | Volume 간 유체 통로 | 밸브, 오리피스, 연결부 |
| **Boundary** | 시스템 경계 조건 | 대기압, 급수 유량 |

---

## 2. 프로젝트 목적: 왜 웹 에디터가 필요한가?

### 기존 방식의 문제점

MARS 시뮬레이션을 실행하려면 **텍스트 입력 파일(.i)**을 작성해야 합니다:

```
*== SINGLE VOLUME ==
1200000  snglvol    core_avg
1200101  0.5  3.0  1.5         * Area, Length, Volume
1200102  0.0  90.0  3.0        * Azimuth, Incline, dZ
...
```

- 수백~수천 줄의 **숫자 나열**
- 한 글자 오타가 전체 시뮬레이션 실패 유발
- 컴포넌트 간 연결 관계를 **머릿속**으로만 파악 가능
- 전문가만 작성 가능

### 이 프로젝트의 해결책

**드래그 앤 드롭** 방식으로 원자로 계통을 시각적으로 설계:

```
┌──────────────────────────────────────────────────────┐
│                    웹 에디터 화면                      │
│  ┌─────────┐         ┌─────────┐         ┌─────────┐ │
│  │ TMDPVOL │─────────│  PIPE   │─────────│ SNGLVOL │ │
│  │ (경계)  │Junction │ (배관)  │Junction │ (노심)  │ │
│  └─────────┘         └─────────┘         └─────────┘ │
│                                                      │
│  [Property Panel] 선택한 컴포넌트 속성 편집           │
│  - 체적: 1.5 m³                                       │
│  - 압력: 15.5 MPa                                     │
└──────────────────────────────────────────────────────┘
           │
           ▼  "Export" 버튼 클릭
┌──────────────────────────────────────────────────────┐
│  자동 생성된 .i 파일                                   │
│  1200000  snglvol  core_avg                          │
│  1200101  0.5  3.0  1.5                              │
│  ...                                                 │
└──────────────────────────────────────────────────────┘
```

---

## 3. 시스템 구성 개요

```
┌─────────────────────────────────────────────────────────┐
│                   사용자 브라우저                         │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │          React 웹 에디터 (이 프로젝트)              │  │
│  │  • 노드 기반 시각 편집기 (ReactFlow)               │  │
│  │  • 속성 입력 폼                                    │  │
│  │  • 실시간 시뮬레이션 모니터링 차트                   │  │
│  └───────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────┘
                         │ 인터넷 (gRPC-Web)
                         ▼
┌─────────────────────────────────────────────────────────┐
│                    서버 (Kubernetes)                     │
│                                                         │
│  ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │ Task Manager    │    │ MARS 시뮬레이터 (Job)        │ │
│  │ (작업 관리)      │───►│ • 입력 파일 실행             │ │
│  │ • 시작/중지      │    │ • 열수력 계산 수행           │ │
│  │ • 로그 전송      │◄───│ • 결과 출력                 │ │
│  └─────────────────┘    └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 핵심 기능 요약

| 기능 | 설명 |
|------|------|
| **시각 편집** | 컴포넌트를 캔버스에 배치하고 연결선으로 연결 |
| **속성 입력** | 각 컴포넌트의 체적, 면적, 초기 조건 등 입력 |
| **파일 생성** | 편집 결과를 MARS 입력 파일(.i)로 자동 변환 |
| **시뮬레이션 실행** | 서버에서 MARS 계산 실행 |
| **실시간 모니터링** | 계산 중 압력/온도/유량 변화를 차트로 표시 |

---

## 4. MARS 입력 카드 구조

MARS 입력 파일은 **카드(Card)** 단위로 구성됩니다. 각 카드 번호가 특정 역할을 담당합니다:

```
┌────────────────────────────────────────────────────────────┐
│                    MARS 입력 파일 구조                       │
├────────────────────────────────────────────────────────────┤
│  Card 100-199  │ 문제 정의 (Problem Definition)            │
│                │ - 계산 유형, 단위계, 가스 조성              │
├────────────────────────────────────────────────────────────┤
│  Card 200-299  │ 시간 설정 (Time Step Control)             │
│                │ - 시작/종료 시간, 시간 간격                 │
├────────────────────────────────────────────────────────────┤
│  Card 300-399  │ Minor Edit (출력 변수 정의)                │
│                │ - 모니터링할 압력, 온도, 유량 지점          │
├────────────────────────────────────────────────────────────┤
│  Card 400-599  │ Variable Trip (조건부 동작)               │
│                │ - "압력이 X 이상이면 트립 발생"             │
├────────────────────────────────────────────────────────────┤
│  Card 600-799  │ Control Variables (제어 변수)             │
│                │ - 계산된 값을 조합하여 새 변수 정의         │
├────────────────────────────────────────────────────────────┤
│  Card 801-999  │ ⭐ Interactive Input (실시간 제어)         │
│                │ - NPA 모드에서 외부 제어 인터페이스         │
├────────────────────────────────────────────────────────────┤
│  Card CCC0000+ │ 컴포넌트 정의 (Hydrodynamic Components)    │
│                │ - SNGLVOL, PIPE, PUMP 등 실제 배관 요소    │
└────────────────────────────────────────────────────────────┘
```

### 카드 번호 체계 예시

```
1200000  snglvol    core_avg     ← CCC=120, 컴포넌트 선언
1200101  0.5  3.0  1.5           ← CCC01XX, 기하 정보
1200102  0.0  90.0  3.0          ← CCC01XX, 각도 정보
1200200  003  15.5e6  600.0      ← CCC02XX, 초기 조건
```

- **CCC**: 컴포넌트 번호 (100-999)
- **뒤 4자리**: 카드 유형 (0101=면적/길이, 0200=초기조건 등)

---

## 5. 실시간 제어: Interactive Input (Card 801-999)

### NPA (Nuclear Plant Analyzer) 모드

MARS는 **NPA 모드**로 실행 시 외부에서 실시간으로 시뮬레이션을 제어할 수 있습니다.
이 프로젝트의 핵심 목표 중 하나는 **웹 브라우저에서 실시간 제어**를 구현하는 것입니다.

```
┌─────────────────────────────────────────────────────────────┐
│                    실시간 제어 흐름                           │
│                                                             │
│   ┌─────────────┐    Card 801-999     ┌─────────────────┐   │
│   │  웹 브라우저 │ ─────────────────► │ MARS 시뮬레이터  │   │
│   │             │    "밸브 열기"       │                 │   │
│   │  [밸브 열기] │                     │ 밸브 면적 변경   │   │
│   │  버튼 클릭   │ ◄───────────────── │                 │   │
│   │             │    결과 스트리밍     │ 유량 변화 계산   │   │
│   └─────────────┘                     └─────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### Interactive Input 카드 유형

| 제어 유형 | 설명 | 사용 예시 |
|-----------|------|-----------|
| **trip** | 트립 상태 제어 | 안전계통 수동 기동 |
| **vlvarea** | 밸브 면적 제어 | PORV 개폐, 격리밸브 |
| **mflowfj** | 액체 유량 제어 | 급수 유량 조절 |
| **mflowgj** | 증기 유량 제어 | 증기 방출 제어 |
| **power** | 히터 출력 제어 | 가압기 히터 ON/OFF |

### 입력 파일 예시

```
*== INTERACTIVE INPUT ==
801  trip      401       "SIS 수동 기동"
802  vlvarea   150       "PORV 개폐 제어"
803  mflowfj   200010001 "RCS 급수 유량"
```

### 개발 접근 방식

1. **입력 파일 생성 시**: 웹 에디터에서 제어할 변수들을 Card 801-999로 정의
2. **시뮬레이션 실행 중**: 웹 UI의 버튼/슬라이더로 해당 변수 값 전송
3. **MARS 계산**: 전송된 값을 반영하여 다음 시간 스텝 계산
4. **결과 스트리밍**: 변경된 결과를 실시간 차트로 표시

이를 통해 **훈련 시뮬레이터** 또는 **운전원 보조 도구**로 활용할 수 있습니다.

---

## 6. 지원 컴포넌트 (열수력 요소)

현재 8종의 MARS 컴포넌트를 지원합니다:

### Volume 계열 (유체가 존재하는 공간)

| 컴포넌트 | 용도 | 비유 |
|----------|------|------|
| **SNGLVOL** | 단일 체적 | 탱크, 헤더 |
| **PIPE** | 다중 셀 배관 | 긴 배관을 여러 구간으로 분할 |
| **BRANCH** | 분기점 | T-접합부, 3방향 이상 연결 |
| **TMDPVOL** | 시간 의존 체적 | 경계 조건 (대기압, 급수 탱크) |
| **PUMP** | 펌프 | 원자로 냉각재 펌프 (RCP) |

### Junction 계열 (유체 통로)

| 컴포넌트 | 용도 | 비유 |
|----------|------|------|
| **SNGLJUN** | 단일 접합부 | 두 Volume 연결 |
| **TMDPJUN** | 시간 의존 접합부 | 유량 경계 조건 |
| **MTPLJUN** | 다중 접합부 | 여러 연결을 한번에 정의 |

---

## 7. 현재 개발 현황

### 완료된 기능 ✅

- [x] 8종 컴포넌트 시각 편집기
- [x] Axial/Crossflow 연결 지원
- [x] MARS 입력 파일(.i) 자동 생성
- [x] 프로젝트 저장/불러오기 (Supabase)
- [x] 시뮬레이션 실행 및 로그 스트리밍
- [x] 실시간 결과 차트 (압력, 온도, 유량)
- [x] Global Settings (시간 설정, 가스 조성 등)

### 진행 중 🚧

- [ ] Docker 환경 설정 개선
- [ ] 통합 테스트 확대
- [ ] 사용자 인증 연동

---

## 8. 기술 스택 (참고)

| 영역 | 기술 |
|------|------|
| Frontend | React 18, TypeScript, ReactFlow, MUI |
| Backend | Python gRPC, Kubernetes |
| Storage | Supabase (프로젝트), MinIO S3 (파일) |
| Communication | Protocol Buffers, gRPC-Web |

---

## 9. 용어 정리

| 용어 | 설명 |
|------|------|
| **열수력 (Thermal-Hydraulics)** | 열전달과 유체역학을 결합한 분야 |
| **Volume** | MARS에서 유체가 존재하는 제어 체적 |
| **Junction** | Volume 간 유체 이동 경로 |
| **Axial 연결** | 배관 축 방향 흐름 (일반적인 직렬 연결) |
| **Crossflow 연결** | 배관 측면 방향 흐름 (옆으로 빠지는 흐름) |
| **EBT** | Equilibrium/Boundary Type - 초기 조건 설정 방식 |
| **TMDP** | Time-Dependent - 시간에 따라 변하는 경계 조건 |
| **Card** | MARS 입력 파일의 기본 단위, 한 줄의 데이터 정의 |
| **NPA** | Nuclear Plant Analyzer - 실시간 제어 가능한 MARS 실행 모드 |
| **Interactive Input** | Card 801-999, 실시간 외부 제어를 위한 인터페이스 정의 |
| **Trip** | 특정 조건 충족 시 동작하는 논리 스위치 (안전계통 기동 등) |

---

*마지막 업데이트: 2025-01-13*
